<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>ECharts</title>
    <!-- 引入 echarts.js -->
    <script src="echarts.js"></script>
</head>
<body>
    <!-- 为ECharts准备一个具备大小（宽高）的Dom -->
    <div id="main" style="width: 1500px;height:800px;"></div>
    <script type="text/javascript">
        var myChart = echarts.init(document.getElementById('main'));
        var link = [
                        {'source': '克隆 ', 'target': '  ', 'value': '0.0',  lineStyle:{opacity: 0 } },
                        {'source': '机制 ', 'target': '机制  ', 'value': '0.008'},
                        {'source': ' ', 'target': '免疫  ', 'value': '0.0',  lineStyle:{opacity: 0 } },
                        {'source': '蛋白 ', 'target': '蛋白  ', 'value': '0.004'},
                        {'source': '分子 ', 'target': '分子  ', 'value': '0.006'},
                        {'source': '基因 ', 'target': '基因  ', 'value': '0.010'},
                        {'source': '分子 ', 'target': '分子  ', 'value': '0.007'},
                    ];
        var data = [
                        {'name': ' ', itemStyle:{color: '#fff',borderColor: '#fff'} },
                        {'name': '基因 '},
                        {'name': '基因  '},
                        {'name': '表达 '},
                        {'name': '植物 '},
                        {'name': '机制 '},
                        {'name': '调控 '},
                        {'name': '分子 '},
                        {'name': '分子  '},

                        {'name': '蛋白 '},
                        {'name': '功能 '},
                        {'name': '发育 '},
                        {'name': '克隆 '},
                    ];

        function setChart(link, data) {
            var option = {
                title: {
                    text: 'Sankey Diagram'},
                tooltip: {
                    trigger: 'item',
                    triggerOn: 'mousemove',
                },
                toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
                },
                series: [
                {
                    type: 'sankey',
                    layout: 'none',
                    layoutIterations: 40,
                    nodeGap: 20,
                    focusNodeAdjacency: 'allEdges',
                    links: link,

                    data: data,
                    itemStyle: {
                        //节点矩形的样式
                        normal: {
                            borderWidth: 1,
                            borderColor: '#aaa',
                        },
                    },

                    lineStyle: {
                        //边的样式
                        normal: {
                            color: 'source',
                            curveness: 0.5}},
                }]
            };
            myChart.showLoading();
            myChart.hideLoading();
            myChart.setOption(option);
        }

        function sleep(delay){
            var start = new Date().getTime();
            while (new Date().getTime() < start + delay);
        }

        function findNode(link, data){
            // 1. 获取旧标签名
            var hint= document.getElementById("hint");
            var tag = document.getElementById("tag");
            oldTag = tag.value;
            var btn= document.getElementById("submit");

            // 2. 判断是否存在该标签
            for (var l of link){
                if ((l["source"] == oldTag) || (l["target"] == oldTag)){
                    alert("请在输入框内输入新的标签名；");
                    hint.innerText = "请输入新的标签名";
                    tag.value = "";
                    tag.setAttribute("id", "newTag");
                    btn.setAttribute("onClick", "changeNode(oldTag, link, data)");
                    return
                }
            }
            alert("请重新输入；");
            tag.value = "";
        }

        function changeNode (oldTag, link, data) {
            var option = {
                title: {
                    text: 'Sankey Diagram'},
                tooltip: {
                    trigger: 'item',
                    triggerOn: 'mousemove',
                },
                toolbox: {
                    feature: {
                        saveAsImage: {}
                    }
                },
                series: [
                {
                    type: 'sankey',
                    layout: 'none',
                    layoutIterations: 40,
                    nodeGap: 20,
                    focusNodeAdjacency: 'allEdges',
                    links: link,

                    data: data,
                    itemStyle: {
                        //节点矩形的样式
                        normal: {
                            borderWidth: 1,
                            borderColor: '#aaa',
                        },
                    },

                    lineStyle: {
                        //边的样式
                        normal: {
                            color: 'source',
                            curveness: 0.5}},
                }]
            };
            var hint= document.getElementById("hint");
            var tag = document.getElementById("newTag");
            var newTag = tag.value;
            var btn= document.getElementById("submit");

            for (var l of link){
                if (l["source"] == oldTag) {
                    l["source"] = newTag;
                }
                if  (l["target"] == oldTag){
                    l["target"] = newTag;
                }
            }

            for (var d of data){
                if (d["name"] == oldTag){
                    d["name"] = newTag;
                }
            }

            alert("已修改好，请查看。");

            sleep(500);
            myChart.setOption(option);

            hint.innerText = "请输入待修改标签名";
            tag.value = "";
            tag.setAttribute("id", "tag");
            btn.setAttribute("onClick", "findNode(link, data)");
        }

        setChart(link, data);


    </script>
    <div>
        <p id='hint'>请输入待修改标签名</p>
        <input type="text" name="name" id="tag" />
        <input type="button" name="button" id="submit" value="提交" onclick="findNode(link, data)" />
    </div>

</body>
</html>